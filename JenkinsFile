node {
    def WORKSPACE = "/var/lib/jenkins/workspace/todo-management-spring-boot"
    // Ensure BUILD_NUMBER is available and set a default if not
    def buildNumber =  "latest"
     //def buildNumber = env.BUILD_NUMBER ?: '0'
    def dockerImageTag = "todo-management-spring-boot:${buildNumber}"

    try {
        // Stage to clone the repository
        stage('Clone Repo') {
            git url: 'https://github.com/rinkuls/todo-management-spring-boot.git',
                credentialsId: 'springdeploy-user',
                branch: 'main'
        }

        // Build the application
        stage('Build') {
            bat "mvn clean install"
        }

        // Build Docker image
        stage('Build Docker') {
            // Set Docker environment to Minikube based on the operating system
            if (isUnix()) {
                // For Linux/macOS
                sh 'eval $(minikube docker-env)' // Configure Docker CLI to use Minikube
            } else {
                // For Windows (CMD)
                bat '''
                @echo off
                FOR /F "tokens=*" %%i IN ('minikube docker-env --shell cmd') DO @call %%i
                '''
            }

            // Verify if the Docker environment is set correctly
            echo "Current Docker context:"
            if (isUnix()) {
                sh 'docker context ls'
            } else {
                bat 'docker context ls'
            }

            echo "Docker Image Tag Name: ${dockerImageTag}"

            // Build the Docker image with the specific tag
            def dockerImage = docker.build(dockerImageTag)

            // Verify the image is built correctly
            echo "Checking available Docker images in Minikube..."
            if (isUnix()) {
                sh 'docker images' // For Unix-based systems
            } else {
                bat 'docker images' // For Windows
            }
        }

        // Verify if image exists before deploying
        stage('Verify Image') {
            echo 'Verifying if Docker image exists in Minikube...'
            if (isUnix()) {
                def imageCheck = sh(script: "docker images -q ${dockerImageTag}", returnStdout: true).trim()
                if (!imageCheck) {
                    error "Docker image ${dockerImageTag} not found in Minikube!"
                }
            } else {
                def imageCheck = bat(script: "docker images -q ${dockerImageTag}", returnStdout: true).trim()
                if (!imageCheck) {
                    error "Docker image ${dockerImageTag} not found in Minikube!"
                }
            }
        }

        // Deploy to Kubernetes
        stage('kubectl deploy') {
            echo 'Deploying to Kubernetes...'
            // Apply the deployment and service configuration files
            bat 'kubectl apply -f app-deployment.yaml'
            bat 'kubectl apply -f app-service.yaml'
        }

        echo 'Deployment to Minikube was successful!'
    } catch (e) {
        echo "in catch"
        currentBuild.result = "FAILED"
        echo "Error: ${e.message}"
        notifyBuild(currentBuild.result)
        throw e
    } finally {
        echo "in finally"
    }
}

def notifyBuild(String buildStatus = 'STARTED') {
    buildStatus = buildStatus ?: 'SUCCESSFUL'
    def now = new Date()
    def subject = "${buildStatus}, Job: ${env.JOB_NAME} FRONTEND - Deployment Sequence: [${env.BUILD_NUMBER}] "
    def subject_email = "Spring Boot Deployment"
    def details = """<p>${buildStatus} JOB </p>
    <p>Job: ${env.JOB_NAME} - Deployment Sequence: [${env.BUILD_NUMBER}] - Time: ${now}</p>
    <p>Check console output at "<a href="${env.BUILD_URL}">${env.JOB_NAME}</a>"</p>"""

    // Email notification
    emailext(
        to: "rinkulsharma123@gmail.com",
        subject: subject_email,
        body: details,
    )
}
