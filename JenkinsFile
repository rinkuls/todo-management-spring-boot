node {
    def WORKSPACE = "/var/lib/jenkins/workspace/todo-management-for-mavenrepo"
    def buildNumber = env.BUILD_NUMBER ?: '0'
    def dockerImageTag = "rinkuls/todo-management-for-mavenrepo:${buildNumber}"

    try {
        // Stage to clone the repository
        stage('Clone Repo') {
            git url: 'https://github.com/rinkuls/todo-management-for-mavenrepo.git',
                credentialsId: 'springdeploy-user',
                branch: 'main'
        }

        // Build the application
        stage('Build') {
            bat "mvn clean install"
        }

        // Build Docker image
        stage('Build Docker Image') {
            echo "Building Docker image with tag: ${dockerImageTag}"

            // Build the Docker image
            def dockerImage = docker.build(dockerImageTag)

            // Verify the image is built correctly
            echo "Docker Image built successfully: ${dockerImageTag}"
        }

        // Push Docker Image to Docker Hub
        stage('Push Docker Image to Docker Hub') {
            withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials-id', passwordVariable: 'DOCKER_HUB_PASSWORD', usernameVariable: 'DOCKER_HUB_USERNAME')]) {
                bat  '''
                    echo %DOCKER_HUB_PASSWORD% | docker login -u %DOCKER_HUB_USERNAME% --password-stdin
                '''
                // Push Docker image to Docker Hub
                bat  "docker push ${dockerImageTag}"
            }
        }

        // Deploy to Kubernetes (Minikube)
        stage('Deploy to Minikube') {
            echo "Deploying to Kubernetes with Docker Hub image: ${dockerImageTag}"

            // Ensure Minikube context is set for Kubernetes
            bat 'kubectl config use-context minikube'

            // Replace the image tag in the deployment YAML with the correct BUILD_NUMBER
            bat "powershell -Command \"(Get-Content app-deployment.yaml) -replace 'rinkuls/todo-management-for-mavenrepo:latest', 'rinkuls/todo-management-for-mavenrepo:${buildNumber}' | Set-Content app-deployment.yaml\""

            // Apply the deployment and service configuration files
            bat 'kubectl apply -f app-deployment.yaml'
            bat 'kubectl apply -f app-service.yaml'
        }

        echo 'Deployment to Minikube was successful!'
    } catch (e) {
        echo "Error occurred: ${e.message}"
        currentBuild.result = "FAILED"
        notifyBuild(currentBuild.result)
        throw e
    } finally {
        echo "in finally"
    }
}

// Email notification function
def notifyBuild(String buildStatus = 'STARTED') {
    buildStatus = buildStatus ?: 'SUCCESSFUL'
    def now = new Date()
    def subject = "${buildStatus}, Job: ${env.JOB_NAME} FRONTEND - Deployment Sequence: [${env.BUILD_NUMBER}] "
    def subject_email = "Spring Boot Deployment"
    def details = """<p>${buildStatus} JOB </p>
    <p>Job: ${env.JOB_NAME} - Deployment Sequence: [${env.BUILD_NUMBER}] - Time: ${now}</p>
    <p>Check console output at "<a href="${env.BUILD_URL}">${env.JOB_NAME}</a>"</p>"""

    // Email notification
    emailext(
        to: "rinkulsharma123@gmail.com",
        subject: subject_email,
        body: details,
    )
}
